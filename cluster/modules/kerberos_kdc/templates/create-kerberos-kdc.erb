#!/bin/bash
KEYDIR=/vagrant/generated/keytabs
<% require 'set';
   password = scope.lookupvar('kerberos_kdc::password');
   nodelist = eval(nodes); 
   users = {'nn' => ['nn', 'HTTP'], 'jt' => ['jt', 'HTTP'], 
            'slave' => ['tt', 'dn'], 'hive-meta' => ['hive']}; -%>

# ensure we don't have old keytabs
rm -fr $KEYDIR
<% nodelist.each do |node| -%>
mkdir -p $KEYDIR/<%= node[:hostname] %>
<% end -%>

# create a new kerberos user database
kdb5_util create -s -P <%= password %>

# create the accounts and keytabs
kadmin.local << EOF
addprinc -pw <%= password %>  vagrant
<% nodelist.each do |node|
     node[:roles].map{|r| users[r]}.flatten.to_set.select {|n| n != nil}.
        each do |user| -%>
addprinc -randkey <%= user %>/<%= node[:hostname] %>.<%= domain %>@<%= realm %>
xst -norandkey -k $KEYDIR/<%= node[:hostname] %>/<%= user %>.keytab <%= user %>/<%= node[:hostname] %>.<%= domain %>@<%= realm %>
<%   end
   end -%>
EOF